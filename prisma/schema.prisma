// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  cards     Card[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Card {
  id           String        @id @default(cuid())
  name         String
  bankName     String
  cardNumber   String        @unique
  cardNetwork  String        // VISA, Mastercard, American Express, etc.
  expiryMonth  Int
  expiryYear   Int
  cardType     String        // Credit, Debit
  isActive     Boolean       @default(true)
  creditLimit  Float?        // Optional credit limit
  userId       String
  user         User          @relation(fields: [userId], references: [id])
  offers       CardOffer[]
  transactions Transaction[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@index([cardNetwork])
  @@index([expiryMonth, expiryYear])
}

model Merchant {
  id           String        @id @default(cuid())
  name         String
  category     String
  transactions Transaction[]
  cardOffers   CardOffer[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model CardOffer {
  id              String      @id @default(cuid())
  cardId          String
  merchantId      String
  card            Card        @relation(fields: [cardId], references: [id])
  merchant        Merchant    @relation(fields: [merchantId], references: [id])
  offerType       String      // CASHBACK, REWARD_POINTS, MILES, DISCOUNT
  percentage      Float
  maxAmount      Float?      // Maximum cashback/discount amount
  minSpend       Float?      // Minimum spend required
  pointsPerRupee Float?      // For reward point offers
  conditions     String?
  validFrom      DateTime
  validUntil     DateTime?
  isRecurring    Boolean     @default(false) // Whether offer repeats monthly
  dayOfMonth     Int?        // Specific day of month for recurring offers
  daysOfWeek     String?     // JSON array of days (e.g., ["SAT", "SUN"])
  maxUsesPerMonth Int?       // Maximum times offer can be used per month
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  @@index([offerType])
  @@index([validFrom, validUntil])
}

model Transaction {
  id         String   @id @default(cuid())
  amount     Float
  cardId     String
  merchantId String
  card       Card     @relation(fields: [cardId], references: [id])
  merchant   Merchant @relation(fields: [merchantId], references: [id])
  cashback   Float?
  date       DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}